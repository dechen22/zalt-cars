<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×›×œ ×”×¨×›×‘×™×</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #c8e6e6; min-height: 100vh; padding: 20px; direction: rtl; }
        .container { max-width: 800px; margin: 0 auto; }
        .header { background: white; border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 20px rgba(0,0,0,0.08); text-align: center; }
        h1 { color: #2d3436; font-size: 22px; font-weight: 600; }
        
        .sync-status { text-align: center; padding: 8px; margin-bottom: 12px; border-radius: 12px; font-size: 13px; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .sync-status.loading { color: #74b9b9; }
        .sync-status.success { color: #00b894; }
        .sync-status.error { color: #ff7675; }
        
        .alerts { margin-bottom: 20px; }
        .alert { background: white; border-radius: 12px; padding: 12px; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 15px rgba(0,0,0,0.06); }
        .alert.urgent { background: #ffe8e8; }
        .alert-icon { font-size: 20px; }
        .alert-content { flex: 1; }
        .alert-title { font-weight: 600; margin-bottom: 2px; color: #2d3436; font-size: 13px; }
        .alert-text { font-size: 12px; color: #636e72; }
        
        .car-card { background: white; border-radius: 20px; padding: 24px; margin-bottom: 16px; box-shadow: 0 2px 20px rgba(0,0,0,0.08); position: relative; }
        .car-header { margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #e8ebed; }
        .car-name { font-size: 22px; font-weight: 600; color: #2d3436; }
        .car-year, .car-license { color: #b2bec3; font-size: 14px; margin-right: 8px; }
        
        .info-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px; }
        .info-item { background: #f8f9fa; padding: 10px; border-radius: 12px; }
        .info-label { font-size: 11px; color: #2d3436; margin-bottom: 4px; font-weight: 600; }
        .info-value { font-weight: 500; color: #2d3436; font-size: 14px; }
        .info-company { font-size: 11px; color: #74b9b9; margin-top: 2px; }
        
        .doc-link { display: inline-block; margin-top: 4px; padding: 4px 8px; background: #74b9b9; color: white; text-decoration: none; border-radius: 6px; font-size: 10px; font-weight: 600; }
        .doc-link:hover { background: #5fa3a3; }
        
        .file-preview { margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 8px; font-size: 12px; }
        .file-preview img { max-width: 100%; max-height: 150px; border-radius: 4px; margin-top: 4px; }
        .remove-file { color: #ff7675; cursor: pointer; font-size: 11px; margin-right: 8px; }
        .remove-file:hover { text-decoration: underline; }
        .days-until { display: inline-block; padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 600; margin-top: 4px; background: #ff7675; color: white; }
        .days-until.ok { display: none; }
        
        .drivers { background: #e8f4f4; padding: 12px; border-radius: 12px; margin-top: 16px; font-size: 14px; color: #2d3436; }
        .notes { background: #fff4e6; padding: 12px; border-radius: 12px; margin-top: 12px; font-size: 13px; color: #636e72; }
        
        .edit-btn { background: white; color: #74b9b9; border: 2px solid #e8ebed; padding: 8px; border-radius: 10px; cursor: pointer; width: 38px; height: 38px; display: flex; align-items: center; justify-content: center; position: absolute; top: 24px; left: 24px; }
        .edit-btn:hover { background: #f8f9fa; border-color: #74b9b9; }
        
        .notification-btn { background: #74b9b9; color: white; border: none; padding: 12px 20px; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 10px rgba(116, 185, 185, 0.2); display: inline-flex; align-items: center; justify-content: center; height: 44px; }
        .notification-btn:hover { background: #5fa3a3; }
        .notification-btn:disabled { background: #dfe6e9; cursor: not-allowed; box-shadow: none; }
        
        .add-car-btn { background: #74b9b9; color: white; border: none; padding: 12px 20px; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 10px rgba(116, 185, 185, 0.2); display: inline-flex; align-items: center; justify-content: center; height: 44px; }
        .add-car-btn:hover { background: #5fa3a3; }
        
        .delete-car-btn { background: #ff7675; color: white; border: none; padding: 12px; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; flex: 1; }
        .delete-car-btn:hover { background: #d63031; }
        .notification-status { text-align: center; padding: 12px 20px; background: #74838a; color: white; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: inline-flex; align-items: center; justify-content: center; cursor: pointer; height: 44px; }
        .notification-status:hover { background: #636e72; }
        
        .button-row { text-align: center; margin-top: 20px; display: flex; justify-content: center; align-items: center; gap: 12px; flex-wrap: wrap; }
        .enabled { color: white; }
        .disabled { color: white; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(45, 52, 54, 0.8); z-index: 1000; padding: 20px; overflow-y: auto; }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 20px; padding: 0; max-width: 500px; width: 100%; max-height: 90vh; box-shadow: 0 10px 40px rgba(0,0,0,0.2); position: relative; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { font-size: 24px; font-weight: 600; color: #2d3436; padding: 24px 28px; border-bottom: 2px solid #e8ebed; position: sticky; top: 0; background: white; z-index: 10; border-radius: 20px 20px 0 0; }
        .modal-body { padding: 0; overflow-y: auto; flex: 1; }
        .modal-section { padding: 24px 28px; }
        .modal-section:nth-child(odd) { background: #e8ebed; }
        .modal-section:nth-child(even) { background: white; }
        .section-title { font-size: 16px; font-weight: 600; color: #74b9b9; margin-bottom: 16px; }
        
        @media (max-width: 600px) {
            .modal-content { max-width: calc(100vw - 20px); }
            .modal-header { font-size: 20px; padding: 16px 20px; }
            .modal-section { padding: 16px 20px; }
            .modal { padding: 10px; }
            .form-input { font-size: 16px; } /* Prevents zoom on iOS */
            .form-input[type="date"] { 
                font-size: 10px; 
                padding: 4px 1px; 
                width: 100%; 
                box-sizing: border-box;
                -webkit-appearance: none;
                -moz-appearance: none;
            }
            .form-group { margin-bottom: 12px; }
        }
        .modal-close { position: absolute; top: 20px; left: 20px; background: none; border: none; font-size: 28px; color: #636e72; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }
        .modal-close:hover { color: #2d3436; }
        .form-group { margin-bottom: 18px; }
        .form-label { display: block; font-weight: 600; margin-bottom: 8px; color: #2d3436; font-size: 14px; }
        
        @media (max-width: 600px) {
            .form-label { font-size: 13px; margin-bottom: 6px; }
        }
        .form-input { width: 100%; padding: 10px; border: 2px solid #dfe6e9; border-radius: 12px; font-size: 14px; direction: rtl; text-align: right; background: white; }
        .form-input[type="date"] { padding: 6px 4px; font-size: 13px; }
        .form-input:focus { outline: none; border-color: #74b9b9; }
        .modal-buttons { display: flex; gap: 12px; margin-top: 28px; padding: 24px 28px; background: white; position: sticky; bottom: 0; border-top: 2px solid #e8ebed; }
        .btn-save { flex: 1; background: #74b9b9; color: white; border: none; padding: 12px; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-save:hover { background: #5fa3a3; }
        .btn-cancel { flex: 1; background: #dfe6e9; color: #2d3436; border: none; padding: 12px; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; }
        .btn-cancel:hover { background: #b2bec3; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>×›×œ ×”×¨×›×‘×™×</h1>
        </div>
        
        <div id="syncStatus" class="sync-status loading">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
        
        <div id="alerts" class="alerts"></div>
        
        <div id="cars"></div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px;">
            <button class="add-car-btn" onclick="addNewCar()" style="margin: 0;">
                â• ×”×•×¡×£ ×¨×›×‘ ×—×“×©
            </button>
            <div class="button-row" style="margin: 0;">
                <button class="notification-btn" id="enableNotifications" onclick="enableNotifications()">
                    ğŸ”” ×”×¤×¢×œ ×”×ª×¨××•×ª
                </button>
                <div class="notification-status" id="notificationStatus" onclick="enableNotifications()">
                    <span class="disabled">×›×™×‘×•×™ ×”×ª×¨××•×ª</span>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="editModal" onclick="closeModalOnOutside(event)">
        <div class="modal-content">
            <div class="modal-header">
                <button class="modal-close" onclick="closeEditModal()">âœ•</button>
                ×¢×¨×•×š ×¤×¨×˜×™ ×¨×›×‘
            </div>
            <div class="modal-body">
                <form id="editForm" onsubmit="saveEdit(event)">
                    <div class="modal-section">
                        <div class="form-group">
                            <label class="form-label">×©× ×”×¨×›×‘</label>
                            <input type="text" class="form-input" id="edit-name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">×©× ×”</label>
                            <input type="text" class="form-input" id="edit-year" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">××¡×¤×¨ ×¨×™×©×•×™</label>
                            <input type="text" class="form-input" id="edit-license" required>
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <div class="section-title">×˜×¡×˜</div>
                        <div class="form-group">
                            <label class="form-label">×‘×ª×•×§×£ ×¢×“</label>
                            <input type="date" class="form-input" id="edit-test" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">××¡××š</label>
                            <input type="url" class="form-input" id="edit-test-doc" placeholder="×”×“×‘×§ ×§×™×©×•×¨ ×-Google Drive...">
                            <small style="color: #636e72; font-size: 11px;">×”×¢×œ×” ×§×•×‘×¥ ×œ-<a href="https://drive.google.com/drive/folders/1SJI8tQJCILbP-Vz6brd8pAd75QJOPZeO" target="_blank" style="color: #74b9b9;">×ª×™×§×™×™×ª Drive</a> ×•×”×“×‘×§ ××ª ×”×§×™×©×•×¨ ×›××Ÿ</small>
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <div class="section-title">×‘×™×˜×•×— ×—×•×‘×”</div>
                        <div class="form-group">
                            <label class="form-label">×—×‘×¨×”</label>
                            <input type="text" class="form-input" id="edit-mandatory-company" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">×‘×ª×•×§×£ ×¢×“</label>
                            <input type="date" class="form-input" id="edit-mandatory-date" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">××¡××š</label>
                            <input type="url" class="form-input" id="edit-mandatory-doc" placeholder="×”×“×‘×§ ×§×™×©×•×¨ ×-Google Drive...">
                            <small style="color: #636e72; font-size: 11px;">×”×¢×œ×” ×§×•×‘×¥ ×œ-<a href="https://drive.google.com/drive/folders/1SJI8tQJCILbP-Vz6brd8pAd75QJOPZeO" target="_blank" style="color: #74b9b9;">×ª×™×§×™×™×ª Drive</a> ×•×”×“×‘×§ ××ª ×”×§×™×©×•×¨ ×›××Ÿ</small>
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <div class="section-title">×‘×™×˜×•×— ××§×™×£ / ×¦×“ ×’'</div>
                        <div class="form-group">
                            <label class="form-label">×¡×•×’ ×‘×™×˜×•×—</label>
                            <input type="text" class="form-input" id="edit-comp-type" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">×—×‘×¨×”</label>
                            <input type="text" class="form-input" id="edit-comp-company" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">×‘×ª×•×§×£ ×¢×“</label>
                            <input type="date" class="form-input" id="edit-comp-date" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">××¡××š</label>
                            <input type="url" class="form-input" id="edit-comp-doc" placeholder="×”×“×‘×§ ×§×™×©×•×¨ ×-Google Drive...">
                            <small style="color: #636e72; font-size: 11px;">×”×¢×œ×” ×§×•×‘×¥ ×œ-<a href="https://drive.google.com/drive/folders/1SJI8tQJCILbP-Vz6brd8pAd75QJOPZeO" target="_blank" style="color: #74b9b9;">×ª×™×§×™×™×ª Drive</a> ×•×”×“×‘×§ ××ª ×”×§×™×©×•×¨ ×›××Ÿ</small>
                        </div>
                    </div>
                    
                    <div class="modal-section">
                        <div class="form-group">
                            <label class="form-label">× ×”×’×™× ××•×¨×©×™×</label>
                            <input type="text" class="form-input" id="edit-drivers" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">×”×¢×¨×•×ª</label>
                            <input type="text" class="form-input" id="edit-notes">
                        </div>
                    </div>
                    
                    <div class="modal-buttons">
                        <button type="submit" class="btn-save">ğŸ’¾ ×©××•×¨</button>
                        <button type="button" class="btn-cancel" onclick="closeEditModal()">âœ–ï¸ ×‘×™×˜×•×œ</button>
                        <button type="button" class="delete-car-btn" onclick="deleteCurrentCar()">ğŸ—‘ï¸ ××—×§ ×¨×›×‘</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        var GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzW53-6mqQrZh4LokLVVlqvDuuOF7Ovnc64dMMIDW4uRpTq19_CJrbQv2QpNRxXYKq8/exec';
        var cars = [];
        var currentEditIndex = -1;

        function showSyncStatus(message, type) {
            var statusEl = document.getElementById('syncStatus');
            statusEl.textContent = message;
            statusEl.className = 'sync-status ' + type;
        }

        function loadFromGoogleSheet() {
            showSyncStatus('×˜×•×¢×Ÿ × ×ª×•× ×™× ××’×•×’×œ...', 'loading');
            
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'GET',
                redirect: 'follow'
            })
                .then(function(response) { 
                    if (!response.ok) {
                        throw new Error('HTTP error! status: ' + response.status);
                    }
                    return response.json(); 
                })
                .then(function(data) {
                    if (data && data.cars) {
                        // Clean dates before using
                        for (var i = 0; i < data.cars.length; i++) {
                            data.cars[i].test = cleanDate(data.cars[i].test);
                            data.cars[i].mandatoryInsurance.date = cleanDate(data.cars[i].mandatoryInsurance.date);
                            data.cars[i].comprehensiveInsurance.date = cleanDate(data.cars[i].comprehensiveInsurance.date);
                        }
                        cars = data.cars;
                        showSyncStatus('âœ“ ×”× ×ª×•× ×™× ×¢×•×“×›× ×•', 'success');
                        setTimeout(function() {
                            document.getElementById('syncStatus').style.display = 'none';
                        }, 2000);
                        renderAlerts();
                        renderCars();
                    } else {
                        throw new Error('Invalid data format');
                    }
                })
                .catch(function(error) {
                    console.error('Error loading data:', error);
                    showSyncStatus('×©×’×™××”: ' + error.message, 'error');
                    // Use fallback data if load fails
                    if (cars.length === 0) {
                        cars = [
                            {
                                name: "×˜×•×™×•×˜×” ×¤×¨×™×•×¡", year: "2014", license: "4658830", test: "24/02/26",
                                mandatoryInsurance: { company: "×”×¤× ×™×§×¡", date: "30/09/26" },
                                comprehensiveInsurance: { type: "×¦×“ ×’'", company: "×”×¤× ×™×§×¡", date: "30/09/26" },
                                drivers: "×•×™×˜×•×¨ ×•×©×¨×”", notes: "×œ×”×•×¡×™×£ ×›×œ × ×”×’, ×œ×©× ×•×ª ×©× ×©×¨×”"
                            },
                            {
                                name: "×¡×§×•×“×”", year: "2018", license: "37354601", test: "18/02/26",
                                mandatoryInsurance: { company: "×‘×™×˜×•×— ×™×©×™×¨", date: "30/11/26" },
                                comprehensiveInsurance: { type: "××§×™×£", company: "×‘×™×˜×•×— ×™×©×™×¨", date: "30/11/26" },
                                drivers: "×›×œ × ×”×’ ××’×™×œ 30 ×©× ×™×", notes: ""
                            },
                            {
                                name: "×¤×•×¨×“ ×¤×•×§×•×¡", year: "2007", license: "4251962", test: "28/01/27",
                                mandatoryInsurance: { company: "×‘×™×˜×•×— ×™×©×™×¨", date: "30/04/26" },
                                comprehensiveInsurance: { type: "×¦×“ ×’'", company: "×‘×™×˜×•×— ×™×©×™×¨", date: "30/04/26" },
                                drivers: "××¡×ª×¨ ×•×’×™×œ×™", notes: "×—×¡×¨ ×¢×•×ª×§ ×¨×™×©×™×•×Ÿ"
                            },
                            {
                                name: "××–×“×” 2", year: "2009", license: "9797165", test: "10/05/26",
                                mandatoryInsurance: { company: "×”×¤×•×œ", date: "31/01/26" },
                                comprehensiveInsurance: { type: "×¦×“ ×’'", company: "×©×•××¨×”", date: "31/10/26" },
                                drivers: "×›×•×œ× ××¢×œ ×’×™×œ 46", notes: "×œ×—×“×© ×‘×™×˜×•×— ×—×•×‘×” - ×œ×©××•×œ ××ª ×œ×¨×™×¡×”"
                            }
                        ];
                        renderAlerts();
                        renderCars();
                        showSyncStatus('××©×ª××© ×‘× ×ª×•× ×™× ×©××•×¨×™×', 'error');
                    }
                });
        }

        function saveToGoogleSheet() {
            showSyncStatus('×©×•××¨ ×©×™× ×•×™×™×...', 'loading');
            
            console.log('Saving cars:', cars);
            
            fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST',
                redirect: 'follow',
                body: JSON.stringify({ cars: cars })
            })
                .then(function(response) { 
                    console.log('Save response status:', response.status);
                    if (!response.ok) {
                        throw new Error('HTTP error! status: ' + response.status);
                    }
                    return response.json(); 
                })
                .then(function(data) {
                    console.log('Save response data:', data);
                    showSyncStatus('âœ“ ×”×©×™× ×•×™×™× × ×©××¨×•', 'success');
                    setTimeout(function() {
                        document.getElementById('syncStatus').style.display = 'none';
                    }, 2000);
                })
                .catch(function(error) {
                    console.error('Error saving data:', error);
                    showSyncStatus('×©×’×™××”: ' + error.message, 'error');
                });
        }

        function parseDate(dateStr) {
            var parts = dateStr.split('/');
            return new Date(2000 + parseInt(parts[2]), parseInt(parts[1]) - 1, parseInt(parts[0]));
        }

        function getDaysUntil(dateStr) {
            var targetDate = parseDate(dateStr);
            var today = new Date();
            var diffTime = targetDate - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function getDaysText(days) {
            if (days < 0) return "×¤×’ ×œ×¤× ×™ " + Math.abs(days) + " ×™××™×!";
            if (days === 0) return "×¤×’ ×”×™×•×!";
            if (days === 1) return "×¤×’ ××—×¨!";
            return "×¢×•×“ " + days + " ×™××™×";
        }

        function getDaysClass(days) {
            return (days <= 45) ? "warning" : "ok";
        }

        // Clean date - handle both DD/MM/YY format and corrupted date strings
        function cleanDate(dateValue) {
            if (!dateValue) return '';
            
            // If it's already in DD/MM/YY format, return it
            if (typeof dateValue === 'string' && dateValue.match(/^\d{2}\/\d{2}\/\d{2}$/)) {
                return dateValue;
            }
            
            // If it's a date string like "Tue Feb 24 2026..."
            if (typeof dateValue === 'string' && dateValue.includes('GMT')) {
                try {
                    var date = new Date(dateValue);
                    var day = ("0" + date.getDate()).slice(-2);
                    var month = ("0" + (date.getMonth() + 1)).slice(-2);
                    var year = String(date.getFullYear()).slice(-2);
                    return day + '/' + month + '/' + year;
                } catch (e) {
                    return '';
                }
            }
            
            return String(dateValue);
        }

        function toDateInput(dateStr) {
            if (!dateStr || typeof dateStr !== 'string') return '';
            var parts = dateStr.split('/');
            if (parts.length !== 3) return '';
            var day = parts[0];
            var month = parts[1];
            var year = '20' + parts[2];
            return year + '-' + month + '-' + day;
        }

        function toDisplayDate(dateStr) {
            if (!dateStr) return '';
            var parts = dateStr.split('-');
            var year = parts[0].substring(2);
            var month = parts[1];
            var day = parts[2];
            return day + '/' + month + '/' + year;
        }

        function renderAlerts() {
            var alertsContainer = document.getElementById('alerts');
            var alerts = [];

            for (var i = 0; i < cars.length; i++) {
                var car = cars[i];
                var testDays = getDaysUntil(car.test);
                var mandatoryDays = getDaysUntil(car.mandatoryInsurance.date);
                var compDays = getDaysUntil(car.comprehensiveInsurance.date);

                if (testDays <= 30) {
                    alerts.push({
                        urgent: testDays <= 14,
                        text: car.name + " - ×˜×¡×˜ " + getDaysText(testDays),
                        subtext: "×ª××¨×™×š: " + car.test
                    });
                }

                if (mandatoryDays <= 30) {
                    alerts.push({
                        urgent: mandatoryDays <= 14,
                        text: car.name + " - ×‘×™×˜×•×— ×—×•×‘×” " + getDaysText(mandatoryDays),
                        subtext: "×—×‘×¨×”: " + car.mandatoryInsurance.company + " | " + car.mandatoryInsurance.date
                    });
                }

                if (compDays <= 30) {
                    alerts.push({
                        urgent: compDays <= 14,
                        text: car.name + " - " + car.comprehensiveInsurance.type + " " + getDaysText(compDays),
                        subtext: "×—×‘×¨×”: " + car.comprehensiveInsurance.company + " | " + car.comprehensiveInsurance.date
                    });
                }
            }

            if (alerts.length === 0) {
                alertsContainer.innerHTML = '';
                return;
            }

            var html = '';
            for (var j = 0; j < alerts.length; j++) {
                var alert = alerts[j];
                html += '<div class="alert ' + (alert.urgent ? 'urgent' : '') + '">';
                html += '<div class="alert-icon">' + (alert.urgent ? 'ğŸš¨' : 'âš ï¸') + '</div>';
                html += '<div class="alert-content">';
                html += '<div class="alert-title">' + alert.text + '</div>';
                html += '<div class="alert-text">' + alert.subtext + '</div>';
                html += '</div></div>';
            }
            alertsContainer.innerHTML = html;
        }

        function renderCars() {
            var carsContainer = document.getElementById('cars');
            var html = "";
            
            for (var i = 0; i < cars.length; i++) {
                var car = cars[i];
                var testDays = getDaysUntil(car.test);
                var mandatoryDays = getDaysUntil(car.mandatoryInsurance.date);
                var compDays = getDaysUntil(car.comprehensiveInsurance.date);

                html += '<div class="car-card">';
                html += '<button class="edit-btn" onclick="openEditModal(' + i + ')">';
                html += '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">';
                html += '<path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>';
                html += '</svg></button>';
                html += '<div class="car-header">';
                html += '<div class="car-name">' + car.name + ' <span class="car-year">' + car.year + '</span> <span class="car-license">' + car.license + '</span></div>';
                html += '</div>';
                
                html += '<div class="info-grid">';
                html += '<div class="info-item">';
                if (car.testFileId) {
                    html += '<div class="info-label"><a href="https://drive.google.com/file/d/' + car.testFileId + '/view" target="_blank" style="color: #74b9b9; text-decoration: underline;">×˜×¡×˜</a></div>';
                } else {
                    html += '<div class="info-label">×˜×¡×˜</div>';
                }
                html += '<div class="info-value">' + car.test + '</div>';
                html += '<span class="days-until ' + getDaysClass(testDays) + '">' + getDaysText(testDays) + '</span>';
                html += '</div>';
                
                html += '<div class="info-item">';
                if (car.mandatoryInsurance.fileId) {
                    html += '<div class="info-label"><a href="https://drive.google.com/file/d/' + car.mandatoryInsurance.fileId + '/view" target="_blank" style="color: #74b9b9; text-decoration: underline;">×‘×™×˜×•×— ×—×•×‘×”</a></div>';
                } else {
                    html += '<div class="info-label">×‘×™×˜×•×— ×—×•×‘×”</div>';
                }
                html += '<div class="info-value">' + car.mandatoryInsurance.date + '</div>';
                html += '<div class="info-company">' + car.mandatoryInsurance.company + '</div>';
                html += '<span class="days-until ' + getDaysClass(mandatoryDays) + '">' + getDaysText(mandatoryDays) + '</span>';
                html += '</div>';
                
                html += '<div class="info-item">';
                if (car.comprehensiveInsurance.fileId) {
                    html += '<div class="info-label"><a href="https://drive.google.com/file/d/' + car.comprehensiveInsurance.fileId + '/view" target="_blank" style="color: #74b9b9; text-decoration: underline;">' + car.comprehensiveInsurance.type + '</a></div>';
                } else {
                    html += '<div class="info-label">' + car.comprehensiveInsurance.type + '</div>';
                }
                html += '<div class="info-value">' + car.comprehensiveInsurance.date + '</div>';
                html += '<div class="info-company">' + car.comprehensiveInsurance.company + '</div>';
                html += '<span class="days-until ' + getDaysClass(compDays) + '">' + getDaysText(compDays) + '</span>';
                html += '</div>';
                html += '</div>';
                
                html += '<div class="drivers"><strong>ğŸ‘¥ × ×”×’×™× ××•×¨×©×™×:</strong> ' + car.drivers + '</div>';
                if (car.notes) {
                    html += '<div class="notes">ğŸ“ ' + car.notes + '</div>';
                }
                html += '</div>';
            }

            carsContainer.innerHTML = html;
        }

        function openEditModal(index) {
            currentEditIndex = index;
            var car = cars[index];
            
            document.getElementById('edit-name').value = car.name;
            document.getElementById('edit-year').value = car.year;
            document.getElementById('edit-license').value = car.license;
            document.getElementById('edit-test').value = toDateInput(car.test);
            document.getElementById('edit-test-doc').value = car.testFileId || '';
            document.getElementById('edit-mandatory-company').value = car.mandatoryInsurance.company;
            document.getElementById('edit-mandatory-date').value = toDateInput(car.mandatoryInsurance.date);
            document.getElementById('edit-mandatory-doc').value = car.mandatoryInsurance.fileId || '';
            document.getElementById('edit-comp-type').value = car.comprehensiveInsurance.type;
            document.getElementById('edit-comp-company').value = car.comprehensiveInsurance.company;
            document.getElementById('edit-comp-date').value = toDateInput(car.comprehensiveInsurance.date);
            document.getElementById('edit-comp-doc').value = car.comprehensiveInsurance.fileId || '';
            document.getElementById('edit-drivers').value = car.drivers;
            document.getElementById('edit-notes').value = car.notes;
            
            document.getElementById('editModal').classList.add('active');
        }
        
        function addNewCar() {
            currentEditIndex = -2; // Special flag for new car
            
            // Clear all fields for new car
            document.getElementById('edit-name').value = "×¨×›×‘ ×—×“×©";
            document.getElementById('edit-year').value = "2024";
            document.getElementById('edit-license').value = "";
            document.getElementById('edit-test').value = "2027-01-01";
            document.getElementById('edit-test-doc').value = "";
            document.getElementById('edit-mandatory-company').value = "";
            document.getElementById('edit-mandatory-date').value = "2027-01-01";
            document.getElementById('edit-mandatory-doc').value = "";
            document.getElementById('edit-comp-type').value = "××§×™×£";
            document.getElementById('edit-comp-company').value = "";
            document.getElementById('edit-comp-date').value = "2027-01-01";
            document.getElementById('edit-comp-doc').value = "";
            document.getElementById('edit-drivers').value = "";
            document.getElementById('edit-notes').value = "";
            
            document.getElementById('editModal').classList.add('active');
        }
        
        function deleteCar(index) {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ' + cars[index].name + '?')) {
                cars.splice(index, 1);
                saveToGoogleSheet();
                renderAlerts();
                renderCars();
            }
        }
        
        function deleteCurrentCar() {
            if (currentEditIndex === -2) {
                // Trying to delete a new car that hasn't been created yet
                closeEditModal();
                return;
            }
            
            if (currentEditIndex === -1 || currentEditIndex >= cars.length) return;
            
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ' + cars[currentEditIndex].name + '?')) {
                cars.splice(currentEditIndex, 1);
                closeEditModal();
                saveToGoogleSheet();
                renderAlerts();
                renderCars();
            }
        }
        
        function showExistingFile(previewId, fileId) {
            var preview = document.getElementById(previewId);
            if (fileId) {
                var html = '<div class="file-preview">';
                html += '<span class="remove-file" onclick="removeExistingFile(\'' + previewId + '\')">âœ–ï¸ ×”×¡×¨</span>';
                html += '<strong>××¡××š ×§×™×™×</strong>';
                html += '<br><a href="https://drive.google.com/file/d/' + fileId + '/view" target="_blank">ğŸ“„ ×¦×¤×” ×‘×§×•×‘×¥</a>';
                html += '</div>';
                preview.innerHTML = html;
            } else {
                preview.innerHTML = '';
            }
        }
        
        function removeExistingFile(previewId) {
            document.getElementById(previewId).innerHTML = '';
            document.getElementById(previewId).dataset.removed = 'true';
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            currentEditIndex = -1;
        }

        function closeModalOnOutside(event) {
            if (event.target === document.getElementById('editModal')) {
                closeEditModal();
            }
        }

        function saveEdit(event) {
            event.preventDefault();
            
            console.log('Saving car, currentEditIndex:', currentEditIndex);
            
            var testDate = document.getElementById('edit-test').value;
            var mandatoryDate = document.getElementById('edit-mandatory-date').value;
            var compDate = document.getElementById('edit-comp-date').value;
            
            console.log('Dates:', testDate, mandatoryDate, compDate);
            
            var carData = {
                name: document.getElementById('edit-name').value,
                year: document.getElementById('edit-year').value,
                license: document.getElementById('edit-license').value,
                test: testDate ? toDisplayDate(testDate) : '',
                testFileId: document.getElementById('edit-test-doc').value || '',
                mandatoryInsurance: {
                    company: document.getElementById('edit-mandatory-company').value,
                    date: mandatoryDate ? toDisplayDate(mandatoryDate) : '',
                    fileId: document.getElementById('edit-mandatory-doc').value || ''
                },
                comprehensiveInsurance: {
                    type: document.getElementById('edit-comp-type').value,
                    company: document.getElementById('edit-comp-company').value,
                    date: compDate ? toDisplayDate(compDate) : '',
                    fileId: document.getElementById('edit-comp-doc').value || ''
                },
                drivers: document.getElementById('edit-drivers').value,
                notes: document.getElementById('edit-notes').value
            };
            
            console.log('Car data:', carData);
            
            if (currentEditIndex === -2) {
                // Adding new car
                console.log('Adding new car');
                cars.push(carData);
            } else if (currentEditIndex >= 0) {
                // Editing existing car
                console.log('Editing car at index', currentEditIndex);
                cars[currentEditIndex] = carData;
            }
            
            console.log('Total cars:', cars.length);
            
            saveToGoogleSheet();
            renderAlerts();
            renderCars();
            closeEditModal();
        }
        
        function readFileAsBase64(file, callback) {
            var reader = new FileReader();
            reader.onload = function(e) {
                callback(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        function enableNotifications() {
            if (!('Notification' in window)) {
                alert('×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘×”×ª×¨××•×ª');
                return;
            }

            if (Notification.permission === 'granted') {
                // Already enabled, show test notification
                new Notification('×”×ª×¨××•×ª ×¤×¢×™×œ×•×ª', {
                    body: '×ª×§×‘×œ ×”×ª×¨××•×ª ×œ×¤× ×™ ×ª××¨×™×›×™ ×—×™×“×•×©',
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y="75" font-size="75">ğŸ””</text></svg>'
                });
                return;
            }

            if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(function(permission) {
                    if (permission === 'granted') {
                        setupNotifications();
                    }
                });
            }
        }

        function setupNotifications() {
            document.getElementById('enableNotifications').disabled = true;
            document.getElementById('notificationStatus').innerHTML = '<span class="enabled">âœ“ ×”×ª×¨××•×ª ××•×¤×¢×œ×•×ª</span>';
            
            new Notification('×ª×–×›×•×¨×•×ª ×¨×›×‘×™× ××•×¤×¢×œ×•×ª! ğŸš—', {
                body: '×ª×§×‘×œ ×”×ª×¨××•×ª ×œ×¤× ×™ ×ª××¨×™×›×™ ×—×™×“×•×©'
            });

            checkAndNotify();
            setInterval(checkAndNotify, 24 * 60 * 60 * 1000);
        }

        function checkAndNotify() {
            for (var i = 0; i < cars.length; i++) {
                var car = cars[i];
                var testDays = getDaysUntil(car.test);
                var mandatoryDays = getDaysUntil(car.mandatoryInsurance.date);
                var compDays = getDaysUntil(car.comprehensiveInsurance.date);

                var notifyDays = [30, 14, 7, 3, 1];
                
                if (notifyDays.indexOf(testDays) !== -1) {
                    new Notification('×ª×–×›×•×¨×ª ×˜×¡×˜ - ' + car.name, {
                        body: '×˜×¡×˜ ×™×¤×•×’ ' + getDaysText(testDays) + ' (' + car.test + ')'
                    });
                }

                if (notifyDays.indexOf(mandatoryDays) !== -1) {
                    new Notification('×ª×–×›×•×¨×ª ×‘×™×˜×•×— ×—×•×‘×” - ' + car.name, {
                        body: '×‘×™×˜×•×— ×—×•×‘×” ×™×¤×•×’ ' + getDaysText(mandatoryDays) + ' (' + car.mandatoryInsurance.company + ')'
                    });
                }

                if (notifyDays.indexOf(compDays) !== -1) {
                    new Notification('×ª×–×›×•×¨×ª ' + car.comprehensiveInsurance.type + ' - ' + car.name, {
                        body: car.comprehensiveInsurance.type + ' ×™×¤×•×’ ' + getDaysText(compDays) + ' (' + car.comprehensiveInsurance.company + ')'
                    });
                }
            }
        }

        if (typeof Notification !== 'undefined' && Notification.permission === 'granted') {
            document.getElementById('enableNotifications').disabled = true;
            document.getElementById('notificationStatus').innerHTML = '<span class="enabled">âœ“ ×”×ª×¨××•×ª ××•×¤×¢×œ×•×ª</span>';
        }

        // Load data on page load
        loadFromGoogleSheet();

        // Refresh from Google Sheets every 5 minutes
        setInterval(loadFromGoogleSheet, 5 * 60 * 1000);

        // Update daily for notifications
        setInterval(function() {
            renderAlerts();
            renderCars();
        }, 24 * 60 * 60 * 1000);
    </script>
</body>
</html>
